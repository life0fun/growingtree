(ns growingtree-app.modals
  (:require [domina :as dom]
            [domina.css :as dc]
            [domina.events :as de]
            [io.pedestal.app.render.push :as render]
            [io.pedestal.app.render.events :as events]
            [io.pedestal.app.render.push.templates :as templates]
            [io.pedestal.app.protocols :as p]
            [io.pedestal.app.messages :as msgs]
            [io.pedestal.app.util.log :as log]
            [io.pedestal.app.render.push.handlers :as h]
            [io.pedestal.app.render.push.handlers.automatic :as auto]
            [growingtree-app.util :as util]
            [growingtree-app.entity-view :as entity-view]
            [growingtree-app.selector :as sel])
  (:require-macros [growingtree-app.html-templates :as html-templates]))


;
; data structure in cljs are cljs.core.X data structure.
;   [node path]  - cljs.core.PersistentVector.
;   vals are cljs.core.PersistentHashMap.
;
; render converts node in nested map to dom element. The root node []
; is configured when we created the render.
;
; render fn has 3 args, render, render op and a input-queue to sends
; data back to app. 
; Render op is specified by transforms in emitter.
; input-queue is used for transform-enable to send back user click event.
; transforms say part of UI should do X and render trigger X on events.
; (defn enable-x [r [transform-enable path transform-name messages] d]
;
; new-id can be used to create the id for the path node, and use that id 
; as div id for the template that attached to the path node.
;     (render/new-id! r path)
;     (render/get-id r path)
;
; add-template attaches template div subtree to a path node. [path ::template]
;   (render/set-data! r (conj path ::template) template)
;
; once template is attached to [:path :node ::template], use update-t to update
; the content of the node with new data map
;   (template/update-t r path {:key new-value})
;
; prepend-t and append-t add div section with data map value to existing 
; template in the node path.
;   (template/prepend-t render path data-map)
;
; when changing template, always gives data map.
;
; the other way is use dom append by-id and dom destroy-children!
;   (dom/append! (dom/by-id "topthings") t)
;   (dom/destroy-children! (dom/by-id "xx"))
;


; node-create, 
;  handle fn got message type as node-create and path in message itself.

; transform message
; transform-enable messages sent from behavior clj, is PersistentArrayMap. It is a Map.
; when come to cljs code, PersistentArrayMap changed to PersistentVector.
; on cljs world, there are only PersistentVector and PersistentMap.
; when sending back to clj, messages converted back to PersistentArrayMap.
; note that when accessing msg params here, need to use (msgs/param :details)


; Load templates macro.
(def templates (html-templates/growingtree-app-templates))


;;================================================================================
;; add multimethod dispatcher to over-write modal title, awesome !
;; over-write any auto namespace mutlimethod to map transkey to modal title.
;;================================================================================
(defmethod auto/modal-title :login-modal [transform-name _]
  (pr-str "Welcome to GrowingTree")
  "Welcome to GrowingTree")

; add listener for upper right login btn and show login modal
; path is login modal, transkey is login-modal, msg has 2 keys, login-name and pass
(def enable-login-modal
  (fn [r [_ path transkey messages] input-queue]
    (let [login-btn (dom/by-id "login")
          modal-evt
            (fn [evt]
              (let [parent-id (render/get-parent-id r path)]
                (.log js/console (str "login modal clicked " path " parent-id " parent-id)
                
                ; (dom/append! (dom/by-id parent-id) modal-html)
                ; (js/showModal (auto/modal-id id transkey))
                (auto/modal-collect-input r input-queue path transkey messages))))
          ]
      (.log js/console (str "setup login modal path " path (render/get-id r path)))
      (de/listen! login-btn :click modal-evt)))) 

